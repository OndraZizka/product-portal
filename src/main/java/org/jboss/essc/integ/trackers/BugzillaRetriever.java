package org.jboss.essc.integ.trackers;

import org.jboss.essc.integ.trackers.model.BugzillaResultWrapper;
import org.jboss.essc.integ.trackers.model.ExternalProjectInfo;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.List;
import org.apache.commons.lang.StringUtils;
import org.codehaus.jackson.map.DeserializationConfig;
import org.codehaus.jackson.map.ObjectMapper;

/**
    https://bugzilla.redhat.com/jsonrpc.cgi?method=Product.get&params=[{%22ids%22:[1,2]}]     params=[{"ids":[226]}]
    EAP id: 226
  
 *  Example output from BZ:
 * 
 *   {"error":null,"id":"https://bugzilla.redhat.com/","result":{
 *      "products":[{
 *          "milestones":[{"is_active":true,"name":"---","id":642,"sort_key":0},{"is_active":true,"name":"DR1","id":1183,"sort_key":1},{"is_active":true,"name":"DR2","id":1184,"sort_key":2},{"is_active":true,"name":"DR3","id":1185,"sort_key":3},{"is_active":true,"name":"DR4","id":1186,"sort_key":4},{"is_active":true,"name":"ER1","id":1187,"sort_key":5},{"is_active":true,"name":"ER2","id":1188,"sort_key":6},{"is_active":true,"name":"ER3","id":1189,"sort_key":7},{"is_active":true,"name":"ER4","id":1190,"sort_key":8},{"is_active":true,"name":"ER5","id":1191,"sort_key":9},{"is_active":true,"name":"ER6","id":1192,"sort_key":10},{"is_active":true,"name":"CR1","id":1193,"sort_key":11},{"is_active":true,"name":"CR2","id":1194,"sort_key":12}],
 *          "name":"JBoss Enterprise Application Platform 6",
 *          "components":[{"default_qa_contact":"","is_active":true,"default_assigned_to":"Flavia Rainone","name":"AOP","id":114790,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Permaine Cheung","name":"Apache Server (httpd) and Connectors","id":114791,"sort_key":0,"description":"Apache Server (httpd) and Connectors like mod_jk"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Fernando Nasser","name":"Build","id":114792,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Paul Ferraro","name":"Clustering","id":114793,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Heiko Braun","name":"Consoles","id":114794,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"Len DiMaggio","is_active":true,"default_assigned_to":"Dennis Gregorovic","name":"distribution","id":102656,"sort_key":0,"description":"General problems that don't fall into other components"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"","name":"doc - Release_Notes","id":108645,"sort_key":0,"description":"Bugs or feature requests in the EAP 6.x Release Notes beyond known/fixed issues e.g. Technical Previews, Features List, Supported Configurations, etc."},{"default_qa_contact":"","is_active":true,"default_assigned_to":"","name":"doc-Administration_and_Configuration_Guide","id":113918,"sort_key":0,"description":"Bugs or feature requests for the EAP 6.x Administration and Configuration Guide"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"","name":"doc-Development_Guide","id":113919,"sort_key":0,"description":"Bugs or feature requests for the EAP 6.x Development Guide"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"","name":"doc-Installation_Guide","id":113921,"sort_key":0,"description":"Bugs or feature requests for the EAP 6.x Installation Guide"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"","name":"doc-Migration_Guide","id":113920,"sort_key":0,"description":"Bugs or feature requests for the EAP 6.x Migration Guide"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"","name":"Documentation","id":108644,"sort_key":0,"description":"Bugs or feature requests for the EAP 6.x documentation suite."},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Xi Huang","name":"Documentation - Translation","id":114795,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Jaikiran Pai","name":"EJB","id":114796,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Yang Yong","name":"Embedded Jopr","id":114797,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Tristan Tarrant","name":"Enterprise Data Grid","id":114798,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Permaine Cheung","name":"EWS","id":114799,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Mike Brock","name":"GWT","id":114800,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Strong Liu","name":"Hibernate","id":114801,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Clebert Suconic","name":"HornetQ","id":114802,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Stefan Guilhen","name":"IIOP","id":114803,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Manik Surtani","name":"Infinispan","id":114804,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Thomas Hauser","name":"Installer","id":114805,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Rajesh Rajasekaran","name":"IPv6 support","id":114806,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Alexey Loubyansky","name":"JBoss Metadata","id":114807,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Fernando Nasser","name":"jbossas","id":102596,"sort_key":0,"description":"JBoss Application Server"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Jesper Pedersen","name":"JCA","id":114808,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Dimitris Andreadis","name":"JMX","id":114809,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Scott Marlow","name":"JPA","id":114810,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Paul Gier","name":"Maven Repository","id":114811,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Yong Hao Gao","name":"Messaging","id":114812,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Ales Justin","name":"Microcontainer and Deployers","id":114813,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Permaine Cheung","name":"mod_cluster","id":114814,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"John Bailey","name":"Naming","id":114815,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Thomas Diesler","name":"OSGi","id":114816,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Fernando Nasser","name":"Other","id":114817,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Anil Saldhana","name":"PicketLink","id":114818,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Jason Greene","name":"Profile Service","id":114819,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"","name":"Quickstarts","id":114820,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Ron Sigal","name":"Remoting","id":114821,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Weinan Li","name":"RESTEasy","id":114822,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Ian Springer","name":"RHQ+EMS","id":114823,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Jay Balunas","name":"RichFaces","id":114824,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Permaine Cheung","name":"Scripts and Commands","id":114825,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Marek Novotny","name":"Seam","id":114826,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Marek Novotny","name":"Seam2","id":114827,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Anil Saldhana","name":"Security","id":114828,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Jason Greene","name":"Server boot","id":114829,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Thomas Hauser","name":"SNMP","id":114830,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Marius Bogoevici","name":"Spring","id":114831,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"David Walluck","name":"Struts","id":114832,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Jason Greene","name":"System","id":114833,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Shelly McGowan","name":"TCK","id":114834,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Ondřej Žižka","name":"Testsuite","id":114835,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Permaine Cheung","name":"Tomcat","id":114836,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"","name":"Transaction Manager","id":114837,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Anne-Louise Tangring","name":"unspecified","id":114789,"sort_key":0,"description":"Default component for JBoss Enterprise Application Platform"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Dimitris Andreadis","name":"Varia","id":114838,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Rémy Maucherat","name":"Web","id":114839,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Alessio Soldano","name":"Web Services","id":114840,"sort_key":0,"description":"Needs a description"},{"default_qa_contact":"","is_active":true,"default_assigned_to":"Marek Novotny","name":"WFK","id":114841,"sort_key":0,"description":"Needs a description"}],
 *          "default_release":"---",
 *          "description":"JBoss Enterprise Application Platform 6",
 *          "versions":[
 *              {"is_active":true,"name":"6.0","id":1258,"sort_key":0},
 *              {"is_active":true,"name":"6.0.1","id":2202,"sort_key":0},
 *              {"is_active":true,"name":"6.1.0","id":2203,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0","id":2456,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR1","id":2431,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 2","id":2432,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 3","id":2433,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 4","id":2434,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 5","id":2435,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 6","id":2436,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 7","id":2437,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 8","id":2438,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 9","id":2439,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 10","id":2440,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 11","id":2441,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 12","id":2442,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 13","id":2443,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 1","id":2444,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 2","id":2445,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 3_Beta1","id":2446,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 4","id":2447,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 5","id":2448,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 6_Beta2","id":2449,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 7","id":2450,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 8","id":2451,"sort_key":0},{"is_active":true,"name":"EAP 6.0.1","id":2455,"sort_key":0},{"is_active":true,"name":"EAP 6.0.1 ER 1","id":2452,"sort_key":0},{"is_active":true,"name":"EAP 6.0.1 ER 2","id":2453,"sort_key":0},{"is_active":true,"name":"EAP 6.0.1 ER 3","id":2454,"sort_key":0},{"is_active":true,"name":"EAP 6.0.2 (SOA)","id":2457,"sort_key":0},{"is_active":true,"name":"EAP 6.1.0","id":2430,"sort_key":0},{"is_active":true,"name":"EAP 6.1.0 DR 1","id":2459,"sort_key":0},{"is_active":true,"name":"EAP 6.2.0","id":2458,"sort_key":0},{"is_active":true,"name":"TBD EAP 6","id":2429,"sort_key":0},{"is_active":true,"name":"unspecified","id":2461,"sort_key":0}],
 *          "default_milestone":"---",
 *          "releases":[{"is_active":true,"name":"---","id":185,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0","id":1020,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 10","id":1008,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 11","id":1009,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 12","id":1010,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 13","id":1011,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 2","id":1000,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 3","id":1001,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 4","id":1002,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 5","id":1003,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 6","id":1004,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 7","id":1005,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 8","id":1006,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR 9","id":1007,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 DR1","id":999,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 1","id":1012,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 2","id":1013,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 3_Beta1","id":1014,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 4","id":1015,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 5","id":1016,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 6_Beta2","id":1017,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 7","id":1018,"sort_key":0},{"is_active":true,"name":"EAP 6.0.0 ER 8","id":1019,"sort_key":0},{"is_active":true,"name":"EAP 6.0.1","id":1024,"sort_key":0},{"is_active":true,"name":"EAP 6.0.1 ER 1","id":1021,"sort_key":0},{"is_active":true,"name":"EAP 6.0.1 ER 2","id":1022,"sort_key":0},{"is_active":true,"name":"EAP 6.0.1 ER 3","id":1023,"sort_key":0},{"is_active":true,"name":"EAP 6.0.2 (SOA)","id":1025,"sort_key":0},{"is_active":true,"name":"EAP 6.1.0","id":1026,"sort_key":0},{"is_active":true,"name":"EAP 6.1.0 DR 1","id":1028,"sort_key":0},{"is_active":true,"name":"EAP 6.2.0","id":1027,"sort_key":0},{"is_active":true,"name":"One-off release","id":1035,"sort_key":0},{"is_active":true,"name":"TBD EAP 6","id":998,"sort_key":0}],
 *          "is_active":true,
 *          "has_unconfirmed":false,
 *          "classification":"JBoss",
 *          "id":226
 *      }]
 *   }}
 *
 *  @author ondra
 */
public class BugzillaRetriever implements IProjectInfoRetriever {

    private ObjectMapper mapper;

    public BugzillaRetriever(){
        mapper = new ObjectMapper();
        mapper.configure(DeserializationConfig.Feature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        mapper.configure(DeserializationConfig.Feature.CAN_OVERRIDE_ACCESS_MODIFIERS, true);
    }

    
    /**
     *  Retrieve project info from Bugzilla.
     */
    public ExternalProjectInfo retrieveProject(String projectId) {
        try {
            BugzillaResultWrapper result = mapper.readValue( getUrlForProject( projectId ), BugzillaResultWrapper.class);
            if( ! StringUtils.isBlank( result.getError() ))
                throw new Exception("Can't retrieve project " + projectId + ", Bugzilla returned: " + result.getError());

            List<ExternalProjectInfo> projects = result.getResult().getProducts();
            ExternalProjectInfo project = projects.get(0);
            project.setLastUpdated(System.currentTimeMillis());
            return project;
        } catch (Exception e) {
            return null;
        }
    }
    
    private URL getUrlForProject( String projectId ){
        try {
            return new URL("https://bugzilla.redhat.com/jsonrpc.cgi?method=Product.get&params=[{%22ids%22:["+projectId+"]}]");
        } catch (MalformedURLException ex) {
            throw new RuntimeException(ex);
        }
    }
    
    public static void main( String[] args ){
        new BugzillaRetriever().retrieveProject("226");
    }
    
}// class
