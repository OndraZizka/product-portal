package org.jboss.essc.integ.trackers;

import org.jboss.essc.integ.trackers.model.ExternalProjectInfo;
import java.net.MalformedURLException;
import java.net.URL;
import org.codehaus.jackson.map.DeserializationConfig.Feature;
import org.codehaus.jackson.map.ObjectMapper;


/**
 * {
 *   "self":"https://issues.jboss.org/rest/api/2/project/AS7",
 *   "id":"12311211",
 *   "key":"AS7",
 *   "description":"JBoss Application Server 7",
 *   "lead":{ "self":"https://issues.jboss.org/rest/api/2/user?username=jason.greene", "name":"jason.greene", "avatarUrls":{"16x16":"https://community.jboss.org/people/jason.greene/avatar/16.png","48x48":"https://community.jboss.org/people/jason.greene/avatar/48.png"},"displayName":"Jason Greene","active":true},
 *   "components":[{"self":"https://issues.jboss.org/rest/api/2/component/12314745","id":"12314745","name":"Application Client","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313801","id":"12313801","name":"Build System","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313825","id":"12313825","name":"CDI / Weld","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313813","id":"12313813","name":"Class Loading","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313802","id":"12313802","name":"CLI","description":"The client side command line interface tool. Use \"Domain Management\" or a specific subsystem for server-side issues found when using the CLI.","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313803","id":"12313803","name":"Clustering","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12315140","id":"12315140","name":"ConfigAdmin","description":"OSGi Configuration Service","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313823","id":"12313823","name":"Console","description":"The HTTP-based admin console. Use \"Domain Management\" or a specific subsystem for server-side issues found when using the admin console.","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12314542","id":"12314542","name":"Documentation","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313804","id":"12313804","name":"Domain Management","description":"Management of hosts or individual servers (including standalone.) Use \"CLI\" or \"Console\" for client side issues related to those tools.","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313805","id":"12313805","name":"EE","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313806","id":"12313806","name":"EJB","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313807","id":"12313807","name":"IIOP","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12314866","id":"12314866","name":"JAXR","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313808","id":"12313808","name":"JCA","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12314875","id":"12314875","name":"JDR","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313828","id":"12313828","name":"JMS","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313809","id":"12313809","name":"JMX","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313810","id":"12313810","name":"JPA / Hibernate","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313811","id":"12313811","name":"JSF","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12314840","id":"12314840","name":"JSR88","description":"JSR88 Deployment","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12315780","id":"12315780","name":"Localization","description":"Translation of internationalized messages into local languages","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313812","id":"12313812","name":"Logging","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12316041","id":"12316041","name":"Mail","description":"Java Mail Integration","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313814","id":"12313814","name":"MSC","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313815","id":"12313815","name":"Naming","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313816","id":"12313816","name":"OSGi","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12314653","id":"12314653","name":"POJO","description":"POJO Container Subsystem","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313817","id":"12313817","name":"Remoting","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12314641","id":"12314641","name":"REST","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12314654","id":"12314654","name":"Scripts","description":"Server control scripts","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313818","id":"12313818","name":"Security","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313829","id":"12313829","name":"Server","description":"The Core Server ","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12314865","id":"12314865","name":"Stilts","description":"STOMP Endpoints","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313819","id":"12313819","name":"Test Suite","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313820","id":"12313820","name":"Transactions","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313821","id":"12313821","name":"VFS","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313822","id":"12313822","name":"Web","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313824","id":"12313824","name":"Web Services","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12313826","id":"12313826","name":"XML Frameworks","isAssigneeTypeValid":false},{"self":"https://issues.jboss.org/rest/api/2/component/12316042","id":"12316042","name":"XTS","isAssigneeTypeValid":false}],
 *   "issueTypes":[{"self":"https://issues.jboss.org/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/newfeature.png","name":"Feature Request","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/13","id":"13","description":"An enhancement or refactoring of existing functionality","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/health.png","name":"Enhancement","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/bug.png","name":"Bug","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/task.png","name":"Task","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/8","id":"8","description":"A one-off patch related to a customer support case","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/improvement.png","name":"Support Patch","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task. Includes patches submitted by community commiters.","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/improvement.png","name":"Patch","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/7","id":"7","description":"Indicates a possible testsuite challenge","iconUrl":"https://issues.jboss.org/images/icons/status_generic.gif","name":"CTS Challenge","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/9","id":"9","description":"A container task to coordinate the tasks for a given release.","iconUrl":"https://issues.jboss.org/images/icons/package_16.gif","name":"Release","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/5","id":"5","description":"The sub-task of the issue","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/subtask_alternate.png","name":"Sub-task","subtask":true},{"self":"https://issues.jboss.org/rest/api/2/issuetype/10","id":"10","description":"A potential bug.","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/genericissue.png","name":"Quality Risk","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/14","id":"14","description":"Upgrade of a library dependency","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/blank.png","name":"Library Upgrade","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/11","id":"11","description":"A subtask tracking an update to a bundled component","iconUrl":"https://issues.jboss.org/images/icons/box.gif","name":"Component Upgrade","subtask":true},{"self":"https://issues.jboss.org/rest/api/2/issuetype/12","id":"12","description":"A task tracking an update to a bundled component","iconUrl":"https://issues.jboss.org/images/icons/box.gif","name":"Component  Upgrade","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/15","id":"15","description":"A clarification needed to a specification based on community feedback","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/task.png","name":"Clarification","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/16","id":"16","description":"A big user story that needs to be broken down.","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/epic.png","name":"Epic","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/17","id":"17","description":"A user story","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/story.png","name":"Story","subtask":false},{"self":"https://issues.jboss.org/rest/api/2/issuetype/18","id":"18","description":"A technical task.","iconUrl":"https://issues.jboss.org/images/icons/issuetypes/task_agile.png","name":"Technical task","subtask":true},{"self":"https://issues.jboss.org/rest/api/2/issuetype/19","id":"19","description":"Issue tracking a bug fix or improvement in another component","iconUrl":"https://issues.jboss.org/images/icons/box.gif","name":"Tracker","subtask":false}],
 *   "url":"http://jboss.org/jbossas",
 *   "assigneeType":"UNASSIGNED",
 *   "versions":[
 *      {
 *          "self":"https://issues.jboss.org/rest/api/2/version/12316378",
 *          "id":"12316378",
 *          "description":"Pertains to no release",
 *          "name":"No Release",
 *          "archived":false,
 *          "released":false
 *      },
 *      {"self":"https://issues.jboss.org/rest/api/2/version/12316372","id":"12316372","name":"7.0.0.Alpha1","archived":false,"released":true,"releaseDate":"2010-11-01","userReleaseDate":"01/Nov/10"},{"self":"https://issues.jboss.org/rest/api/2/version/12316373","id":"12316373","name":"7.0.0.Beta1","archived":false,"released":true,"releaseDate":"2011-03-15","userReleaseDate":"15/Mar/11"},{"self":"https://issues.jboss.org/rest/api/2/version/12316374","id":"12316374","name":"7.0.0.Beta2","archived":false,"released":true,"releaseDate":"2011-04-01","userReleaseDate":"01/Apr/11"},{"self":"https://issues.jboss.org/rest/api/2/version/12316375","id":"12316375","name":"7.0.0.Beta3","archived":false,"released":true,"releaseDate":"2011-04-19","userReleaseDate":"19/Apr/11"},{"self":"https://issues.jboss.org/rest/api/2/version/12316377","id":"12316377","name":"7.0.0.CR1","archived":false,"released":true,"releaseDate":"2011-06-29","userReleaseDate":"29/Jun/11"},{"self":"https://issues.jboss.org/rest/api/2/version/12317184","id":"12317184","description":"Final Release","name":"7.0.0.Final","archived":false,"released":true,"releaseDate":"2011-07-12","userReleaseDate":"12/Jul/11"},{"self":"https://issues.jboss.org/rest/api/2/version/12317200","id":"12317200","description":"Bug Fix Release","name":"7.0.1.Final","archived":false,"released":true,"releaseDate":"2011-08-17","userReleaseDate":"17/Aug/11"},{"self":"https://issues.jboss.org/rest/api/2/version/12317953","id":"12317953","description":"Bug Fix Release","name":"7.0.2.Final","archived":false,"released":true,"releaseDate":"2011-09-22","userReleaseDate":"22/Sep/11"},{"self":"https://issues.jboss.org/rest/api/2/version/12318487","id":"12318487","description":"Patch release containing critical fixes and security updates","name":"7.0.2.SP1","archived":false,"released":false},{"self":"https://issues.jboss.org/rest/api/2/version/12316685","id":"12316685","name":"7.1.0.Alpha1","archived":false,"released":true,"releaseDate":"2011-09-18","userReleaseDate":"18/Sep/11"},{"self":"https://issues.jboss.org/rest/api/2/version/12316686","id":"12316686","name":"7.1.0.Beta1","archived":false,"released":true,"releaseDate":"2011-11-22","userReleaseDate":"22/Nov/11"},{"self":"https://issues.jboss.org/rest/api/2/version/12318638","id":"12318638","description":"Compatibility patch to beta1","name":"7.1.0.Beta1b","archived":false,"released":true,"releaseDate":"2011-12-02","userReleaseDate":"02/Dec/11"},{"self":"https://issues.jboss.org/rest/api/2/version/12316687","id":"12316687","name":"7.1.0.CR1","archived":false,"released":true,"releaseDate":"2011-12-22","userReleaseDate":"22/Dec/11"},{"self":"https://issues.jboss.org/rest/api/2/version/12318697","id":"12318697","description":"Stability patch to CR1","name":"7.1.0.CR1b","archived":false,"released":true,"releaseDate":"2011-12-23","userReleaseDate":"23/Dec/11"},{"self":"https://issues.jboss.org/rest/api/2/version/12318489","id":"12318489","description":"Final 7.1 Release Full EE, Lots of Domain Goodies","name":"7.1.0.Final","archived":false,"released":true,"releaseDate":"2012-02-16","userReleaseDate":"16/Feb/12"},{"self":"https://issues.jboss.org/rest/api/2/version/12318875","id":"12318875","name":"7.1.1.Final","archived":false,"released":true,"releaseDate":"2012-03-09","userReleaseDate":"09/Mar/12"},{"self":"https://issues.jboss.org/rest/api/2/version/12319174","id":"12319174","description":"Tag used by EAP Only","name":"7.1.2.Final (EAP)","archived":false,"released":true,"releaseDate":"2012-05-09","userReleaseDate":"09/May/12"},{"self":"https://issues.jboss.org/rest/api/2/version/12319535","id":"12319535","description":"Tag used by EAP Only","name":"7.1.3.Final (EAP)","archived":false,"released":true,"releaseDate":"2012-09-21","userReleaseDate":"21/Sep/12"},{"self":"https://issues.jboss.org/rest/api/2/version/12318469","id":"12318469","description":"First 7.2 release","name":"7.2.0.Alpha1","archived":false,"released":false},{"self":"https://issues.jboss.org/rest/api/2/version/12319789","id":"12319789","description":"First 7.2 Candidate Release","name":"7.2.0.CR1","archived":false,"released":false},{"self":"https://issues.jboss.org/rest/api/2/version/12319790","id":"12319790","description":"First 7.3 release","name":"7.3.0.Alpha1","archived":false,"released":false},{"self":"https://issues.jboss.org/rest/api/2/version/12319914","id":"12319914","description":"Tag used by EAP, Source only release","name":"7.1.4.Final (EAP)","archived":false,"released":false},{"self":"https://issues.jboss.org/rest/api/2/version/12316379","id":"12316379","description":"Issues that are considered valid, but are only expected to be completed if a community member takes them on. Hence they are unscheduled pending a commitment from a community member.","name":"Open To Community","archived":false,"released":false}],
 *   "name":"Application Server 7",
 *   "roles":{"Users":"https://issues.jboss.org/rest/api/2/project/AS7/role/10000","Administrators":"https://issues.jboss.org/rest/api/2/project/AS7/role/10002","Developers":"https://issues.jboss.org/rest/api/2/project/AS7/role/10001","Subscribers":"https://issues.jboss.org/rest/api/2/project/AS7/role/10020","Private Reviewers":"https://issues.jboss.org/rest/api/2/project/AS7/role/10010","Patch Contributor":"https://issues.jboss.org/rest/api/2/project/AS7/role/10030"},
 *   "avatarUrls":{"16x16":"https://issues.jboss.org/secure/projectavatar?size=small&pid=12311211&avatarId=10763","48x48":"https://issues.jboss.org/secure/projectavatar?pid=12311211&avatarId=10763"}
 * }
 * 
 * @author Ondrej Zizka
 */
public class JiraRetriever implements IProjectInfoRetriever {
    
    private ObjectMapper mapper;

    public JiraRetriever(){
        mapper = new ObjectMapper();
        mapper.configure(Feature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        mapper.configure(Feature.CAN_OVERRIDE_ACCESS_MODIFIERS, true);
    }

    
    /**
     *  Retrieve project info from Jira.
     */
    public ExternalProjectInfo retrieveProject(String projectId) {
        try {
            ExternalProjectInfo project = mapper.readValue( getUrlForProject( projectId ), ExternalProjectInfo.class );
            project.setLastUpdated(System.currentTimeMillis());
            return project;
        } catch (Exception e) {
            return null;
        }
    }
    
    private URL getUrlForProject( String projectId ){
        try {
            return new URL("https://issues.jboss.org/rest/api/2/project/" + projectId);
        } catch (MalformedURLException ex) {
            throw new RuntimeException(ex);
        }
    }

}// class
